requirejs.config({
    baseUrl: '/dependencies/can-minified'
});

var fiso, uploaded;

requirejs(["/dependencies/can-minified/FipCanConfig.js", "Can"], 
    function(CONFIG, Can) {
	
        can = new Can(CONFIG, CONFIG.api_key, CONFIG.api_key_secret);

        // Create FSIO client.
   	    fsio = can.createFsioClient();
        
    }
);

function uploadFile(token, path, file) {
    fsio.data.partialUploadInit(token, path, function(jqXHR,textStatus) {
        
        var uploadId = jqXHR.getResponseHeader("upload-id");
            
        // Setup ajax calls when uploading data
        var defaultContentType = $.ajaxSettings.contentType;
        var defaultProcessData = $.ajaxSettings.processData;
        $.ajaxSetup({
            contentType : false,
            processData : false
        });
        Blob.prototype.substring = Blob.prototype.slice;
        file.length = file.size;
        fsio.data.uploadPartially(token, uploadId, file, file.length, function(jqXHR) {
            $.ajaxSetup({
                contentType : defaultContentType,
                processData : defaultProcessData
            });

            if(jqXHR.status == 204) {
                console.log("Submission successful");
                var postdata = {
                    "filename" : file.name
                };
                var posturl = "/api/v2" + window.location.pathname + "/submissions";
                $.post(posturl,postdata,function(data){
                    console.log(data);
		    uploaded = true;	
                },"json");
            }
            else {
                console.log("Error while submitting your file");    
            }   
        });
    });
}
