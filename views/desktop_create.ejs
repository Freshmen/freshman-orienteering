<!DOCTYPE HTML>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<title>Freshman Orienteering Desktop Client</title>
	<link rel='stylesheet' href='/stylesheets/desktop.css' />
	<script src="http://api.maps.nokia.com/2.2.3/jsl.js"></script>
	<!-- For now commenting this to include a full jquery lib
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
	-->
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css" />
	<script src="http://code.jquery.com/jquery-1.8.2.js"></script>
    	<script src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>
	<!-- Time Picker Widget -->
	<script src="/javascripts/timepicker.js"></script>
</head>
<body>
		<header id="banner" class="body">
		<h1><a href="desktop">Freshman Orienteering</a></h1>
		<nav><ul>
			<li><a href="desktop">Home</a></li>
			<li class="active"><a href="desktop_create">Create Event</a></li>
			<li><a href="#">Manage Events</a></li>
		</ul></nav>
	</header>

	<section id="content">
				<form id="event_form" action="">
					<input type="text" id="title" size="30" placeholder="Event Name" style="font-size: 36px; width: 100%" required><br /><br />
					<input type="text" id="starttime" style="font-size: 18px; width: 100%" value="" placeholder="Start Time "required><br />
					<input type="text" id="endtime" style="font-size: 18px; width: 100%" placeholder="End Time" value="" required>
					<br /><br /><input type="checkbox" id="ordered" title="Select this if the checkpoints are ordered. Shuffle around to make the order."><label title="Select this if the checkpoints are ordered. Shuffle around to make the order.">Ordered checkpoints</label><br /><br />
					<input type="submit" id="submit" value="Create Event" class="button">
				</form>
				<div id="mapArea"></div>
				<div id ="checkpoint_holder">
					<input type="button" id="addOption" value="New Checkpoint" class="button"><br />
				</div>
	</section>
	
	<script src="http://api.maps.nokia.com/2.2.3/jsl.js"></script>
	<script src="/javascripts/notifier.js"></script>
	<script src="/javascripts/nokiaMaps.js"></script>
	<script src="/javascripts/geolocation.js"></script>
	
	<script>
		var i = 0;
		$(document).ready(function(){
			$("#addOption").hide();
			$("#starttime").datetimepicker({useLocalTimezone : true});
			$("#endtime").datetimepicker({useLocalTimezone : true});
			$( "#checkpoint_holder" ).sortable({
				stop: function(event, ui) {
        				fixIds();
    				}
    			});
		});
		$('#addOption').click(function (){

			$('<div class="drag-container"><div class="top"><span></span></div><div class="center-content"></div><div class="bottom"><span></span></div> </div>').insertBefore('#addOption');
			$(".center-content").last().append('<form id="checkpoint"></form>');
			i++;
			$('#checkpoint').append('<img src="images/trash.jpg" class="trash" onclick=removeMe(this) style="float:right; margin:0 5px 0 0; height: auto; width: 20px;"><img src="images/save.png" class="save" onclick=saveMe(this) style="float:right; margin:0 5px 0 0; height: auto; width: 24px;"><h2>Checkpoint ' + i + '</h2>');
			$('#checkpoint').append('<input type="text" id="title" placeholder="Title" required>');
			$('#checkpoint').append('<input type="text" id="altitude" placeholder="Altitude" required>');
			$('#checkpoint').append('<input type="text" id="latitude" placeholder="Latitude" required>');
			$('#checkpoint').append('<input type="text" id="longitude" placeholder="Longitude" required>');
			$('#checkpoint').append('<input type="text" id="taskURL" placeholder="Task URL" required>');
			$('#checkpoint').attr("id","checkpoint_" + i);
			<!-- $('.drag-container').last().draggable({ axis: "y", containment: "parent", scroll: false , snap: "true", snapMode: "outer" }); -->
			fixIds();
		});

		$('#event_form').submit(function(){
		    var event_details = {};
			$("#event_form").children().filter(":text").each(function() {
				if ($(this).attr("id") == 'starttime' || $(this).attr("id") == 'endtime'){
					var date = new Date($(this).val());
					event_details[$(this).attr("id")] = date.toJSON();
				}
				else {
					event_details[$(this).attr("id")] = $(this).val();
				}
			});
			event_details["ordered"] = $('#ordered').attr('checked')?true:false;
			console.log(event_details);
			$.post("/api/v1/events/",event_details,function(){});
 			
			<!-- Display add checkpoint button -->	
 			$("#addOption").trigger('click');
 			$("#addOption").show();

 			<!-- Disable editing on the event details form -->
 			$("#title").attr("disabled","true");
 			$("#starttime").attr("disabled","true");
 			$("#endtime").attr("disabled","true");
 			$("#ordered").attr("disabled","true");
			$("#submit").attr("disabled","true");
 			return false;
		});
		
		function fixIds() {
			var j = 1;
			
			$("#checkpoint_holder form").each(function(){
        			$(this).attr("id","checkpoint_" + j++);
        		});
        		j = 1;
        		$("#checkpoint_holder h2").each(function(){
        			$(this).text("Checkpoint " + j++);
        		});
		}

		function saveMe(floppy) {
			var floppyParent = {};
			$(".save:last").parent().children().filter("input").each(function(){
				floppyParent[$(this).attr("id")] = $(this).val();
			})
			$.post("http://localhost:3000/api/v1/test/",floppyParent,function(){});
		};
	
		function removeMe(dustbin){

			$(dustbin).parent().parent().parent().fadeTo("normal", 0.01, function(){ //fade
             			$(this).slideUp("normal", function() { //slide up
                 			$(this).remove(); //then remove from the DOM
					fixIds();
             			});
         		});
		};

	</script>

	
</body>
</html>
